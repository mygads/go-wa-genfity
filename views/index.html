<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.4/css/dataTables.semanticui.min.css">
    <link rel="stylesheet" href="{{ .AppBasePath }}/assets/app.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.4/js/dataTables.semanticui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <title>WhatsApp API {{ .AppVersion }}</title>
</head>
<body>
<div id="splash-screen">
    <!-- Clean squircle logo without background wrapper -->
    <img src="{{ .AppBasePath }}/assets/logo-light.svg" alt="Genfity Logo" class="splash-icon" id="main-logo">

    <h2 class="splash-title">Genfity WhatsApp API</h2>
    <div class="ui active large inline loader splash-spinner"></div>
</div>

<div class="ui container" id="app" style="display: none;">
    <div class="main-header" style="position: relative;">
        <!-- User Info Display - Made more visible -->
        <div class="user-info-container" style="position: absolute; top: 5px; left: 5px; z-index: 1000;">
            {{ if and .Username .UserID }}
            <div class="ui small teal label" style="background: #17a2b8 !important; color: white !important; font-weight: bold !important;">
                <i class="user icon"></i>
                {{ .Username }}
                <div class="detail !important">ID: {{ .UserID }}</div>
            </div>
            {{ else }}
            <div class="ui small orange label" style="background: #fd7e14 !important; color: white !important;">
                <i class="exclamation triangle icon"></i>
                User Info Missing
            </div>
            {{ end }}
        </div>
        
        <!-- Logout Application Button (Desktop) -->
        <div class="logout-app-container desktop-only" style="position: absolute; top: 10px; right: 10px;">
            <button class="ui red button" @click="logoutApplication" title="Logout dari Aplikasi">
                <i class="sign out icon"></i>
                Logout App
            </button>
        </div>
        
        <h1 class="ui header center aligned">
            <div class="title-container">
                <img src="{{ .AppBasePath }}/assets/logo-light.svg" alt="Genfity Logo" style="margin-right: 15px;">
                
                <span>Genfity WhatsApp API</span>
                
                <div class="version-label">
                    {{ .AppVersion }}
                </div>
            </div>
        </h1>

        <!-- Multi-User Status Info -->
        <div class="ui info message" style="margin-top: 15px;">
            <div class="header">
                <i class="users icon"></i>
                Multi-User Session Active
            </div>
            <p>
                {{ if .Username }}
                You are currently using a separate session fully isolated from other users.
                All WhatsApp operations (send, group, message) use a dedicated client for user <strong>{{ .Username }}</strong>.
                {{ else }}
                <span style="color: red;">⚠️ DEBUG: User info not found. Username: "{{ .Username }}", UserID: "{{ .UserID }}"</span>
                {{ end }}
            </p>
        </div>
    </div>

    <div class="ui success message" v-if="connected_devices != null">
        <div class="header">
            <i class="check circle icon"></i>
            Device Connected Successfully
        </div>
        <p>
            Device ID: <b>[[ connected_devices[0].device ]]</b>
        </p>
    </div>

    <div class="ui horizontal divider">
        App
    </div>

    <div class="ui three column stackable grid cards">
        <app-login :connected="connected_devices"></app-login>
        <app-logout @reload-devices="handleReloadDevice"></app-logout>
        <app-reconnect @reload-devices="handleReloadDevice"></app-reconnect>
        <app-login-with-code :connected="connected_devices"></app-login-with-code>
    </div>

    <div class="ui horizontal divider">
        Send
    </div>

    <div class="ui three column doubling grid cards">
        <send-message></send-message>
        <send-image></send-image>
        <send-file max-file-size="{{ .MaxFileSize }}"></send-file>

        <send-video max-video-size="{{ .MaxVideoSize }}"></send-video>
        <send-contact></send-contact>
        <send-location></send-location>

        <send-audio></send-audio>
        <send-poll></send-poll>
        <send-presence></send-presence>
        
        <send-chat-presence></send-chat-presence>
        <send-link></send-link>
    </div>

    <div class="ui horizontal divider">
        Message
    </div>

    <div class="ui three column doubling grid cards">
        <message-delete></message-delete>
        <message-revoke></message-revoke>
        <message-react></message-react>
        <message-update></message-update>
        <message-read></message-read>
    </div>

    <div class="ui horizontal divider">
        Group
    </div>

    <div class="ui three column doubling grid cards">
        <group-list :connected="connected_devices"></group-list>
        <group-create></group-create>
        <group-join-with-link></group-join-with-link>
        <group-info-from-link></group-info-from-link>
        <group-add-participants></group-add-participants>
        <group-set-photo></group-set-photo>
        <group-set-name></group-set-name>
        <group-set-locked></group-set-locked>
        <group-set-announce></group-set-announce>
        <group-set-topic></group-set-topic>
        <group-info></group-info>
    </div>

    <div class="ui horizontal divider">
        Newsletter
    </div>

    <div class="ui three column doubling grid cards">
        <newsletter-list></newsletter-list>
    </div>

    <div class="ui horizontal divider">
        Account
    </div>

    <div class="ui three column doubling grid cards">
        <account-avatar></account-avatar>
        <account-change-avatar></account-change-avatar>
        <account-change-push-name></account-change-push-name>
        <account-user-info></account-user-info>
        <account-business-profile></account-business-profile>
        <account-privacy></account-privacy>
        <account-contact></account-contact>
        <account-user-check></account-user-check>
    </div>

    <div class="ui horizontal divider">
        Chat Management
    </div>

    <div class="ui three column doubling grid cards">
        <chat-pin-manager></chat-pin-manager>
        <chat-list></chat-list>
        <chat-messages></chat-messages>
    </div>

</div>
<script>
    window.TYPEGROUP = "@g.us";
    window.TYPEUSER = "@s.whatsapp.net";
    window.TYPENEWSLETTER = "@newsletter";
    window.TYPESTATUS = "status@broadcast";
    window.showErrorInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Error',
            message: message,
            showProgress: 'bottom',
            classProgress: 'red'
        });
    }
    window.showSuccessInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Success',
            message: message,
            showProgress: 'bottom',
            classProgress: 'green'
        });
    }


    window.http = axios.create({
        baseURL: `${window.location.protocol}//${window.location.hostname}${window.location.port ? ':' + window.location.port : ''}{{ .AppBasePath }}`
    });
    {{ if isEnableBasicAuth .BasicAuthToken }}
    window.http.defaults.headers.common['Authorization'] = "{{ .BasicAuthToken }}";
    {{ end }}
</script>
<script type="module">
    import AppLogin from "{{ .AppBasePath }}/components/AppLogin.js";
    import AppLoginWithCode from "{{ .AppBasePath }}/components/AppLoginWithCode.js";
    import AppLogout from "{{ .AppBasePath }}/components/AppLogout.js";
    import AppReconnect from "{{ .AppBasePath }}/components/AppReconnect.js";
    import SendMessage from "{{ .AppBasePath }}/components/SendMessage.js";
    import SendImage from "{{ .AppBasePath }}/components/SendImage.js";
    import SendFile from "{{ .AppBasePath }}/components/SendFile.js";
    import SendVideo from "{{ .AppBasePath }}/components/SendVideo.js";
    import SendLink from "{{ .AppBasePath }}/components/SendLink.js";
    import SendContact from "{{ .AppBasePath }}/components/SendContact.js";
    import SendLocation from "{{ .AppBasePath }}/components/SendLocation.js";
    import SendAudio from "{{ .AppBasePath }}/components/SendAudio.js";
    import SendPoll from "{{ .AppBasePath }}/components/SendPoll.js";
    import SendPresence from "{{ .AppBasePath }}/components/SendPresence.js";
    import SendChatPresence from "{{ .AppBasePath }}/components/SendChatPresence.js";
    import MessageDelete from "{{ .AppBasePath }}/components/MessageDelete.js";
    import MessageUpdate from "{{ .AppBasePath }}/components/MessageUpdate.js";
    import MessageReact from "{{ .AppBasePath }}/components/MessageReact.js";
    import MessageRevoke from "{{ .AppBasePath }}/components/MessageRevoke.js";
    import MessageRead from "{{ .AppBasePath }}/components/MessageRead.js";
    import GroupList from "{{ .AppBasePath }}/components/GroupList.js";
    import GroupCreate from "{{ .AppBasePath }}/components/GroupCreate.js";
    import GroupJoinWithLink from "{{ .AppBasePath }}/components/GroupJoinWithLink.js";
    import GroupInfoFromLink from "{{ .AppBasePath }}/components/GroupInfoFromLink.js";
    import GroupAddParticipants from "{{ .AppBasePath }}/components/GroupManageParticipants.js";
    import GroupSetPhoto from "{{ .AppBasePath }}/components/GroupSetPhoto.js";
    import GroupSetName from "{{ .AppBasePath }}/components/GroupSetName.js";
    import GroupSetLocked from "{{ .AppBasePath }}/components/GroupSetLocked.js";
    import GroupSetAnnounce from "{{ .AppBasePath }}/components/GroupSetAnnounce.js";
    import GroupSetTopic from "{{ .AppBasePath }}/components/GroupSetTopic.js";
    import GroupInfo from "{{ .AppBasePath }}/components/GroupInfo.js";
    import NewsletterList from "{{ .AppBasePath }}/components/NewsletterList.js";
    import AccountAvatar from "{{ .AppBasePath }}/components/AccountAvatar.js";
    import AccountChangeAvatar from "{{ .AppBasePath }}/components/AccountChangeAvatar.js";
    import AccountChangePushName from "{{ .AppBasePath }}/components/AccountChangePushName.js";
    import AccountUserInfo from "{{ .AppBasePath }}/components/AccountUserInfo.js";
    import AccountPrivacy from "{{ .AppBasePath }}/components/AccountPrivacy.js";
    import AccountContact from "{{ .AppBasePath }}/components/AccountContact.js";
    import AccountUserCheck from "{{ .AppBasePath }}/components/AccountUserCheck.js";
    import AccountBusinessProfile from "{{ .AppBasePath }}/components/AccountBusinessProfile.js";
    import ChatPinManager from "{{ .AppBasePath }}/components/ChatPinManager.js";
    import ChatList from "{{ .AppBasePath }}/components/ChatList.js";
    import ChatMessages from "{{ .AppBasePath }}/components/ChatMessages.js";

    const showErrorInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Error',
            message: message,
            showProgress: 'bottom',
            classProgress: 'red'
        });
    }
    const showSuccessInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Success',
            message: message,
            showProgress: 'bottom',
            classProgress: 'green'
        });
    }

    const constructWebSocketURL = () => {
        const protocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
        const basePath = '{{ .AppBasePath }}';
        
        return `${protocol}${location.host}${basePath}/ws`;
    };

    Vue.createApp({
        components: {
            AppLogin, AppLoginWithCode, AppLogout, AppReconnect,
            SendMessage, SendImage, SendFile, SendVideo, SendLink, SendContact, SendLocation, SendAudio, SendPoll, SendPresence, SendChatPresence,
            MessageDelete, MessageUpdate, MessageReact, MessageRevoke, MessageRead,
            GroupList, GroupCreate, GroupJoinWithLink, GroupInfoFromLink, GroupAddParticipants, GroupSetPhoto, GroupSetName, GroupSetLocked, GroupSetAnnounce, GroupSetTopic, GroupInfo,
            NewsletterList,
            AccountAvatar, AccountUserInfo, AccountPrivacy, AccountChangeAvatar, AccountContact, AccountChangePushName, AccountUserCheck, AccountBusinessProfile,
            ChatPinManager, ChatList, ChatMessages
        },
        delimiters: ['[[', ']]'],
        data() {
            return {
                app_ws: null,
                connected_devices: null,
            }
        },
        methods: {
            handleReloadDevice() {
                this.app_ws.send(JSON.stringify({"code": "FETCH_DEVICES"}))
            },
            logoutApplication() {
                // Show confirmation dialog
                if (confirm('Are you sure you want to logout from the application?\n\nNOTE: To fully logout from Basic Auth, you need to close this browser tab/window after logout.')) {
                    // Close WebSocket connection
                    if (this.app_ws) {
                        this.app_ws.close();
                    }
                    
                    // Clear stored authentication
                    delete window.http.defaults.headers.common['Authorization'];
                    
                    // Show success message
                    showSuccessInfo('Logout successful! Please close this browser tab or click "Refresh & Force Re-login" below.');
                    
                    // Hide main app content and show logout message
                    setTimeout(() => {
                        document.getElementById('app').innerHTML = `
                            <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 10px; padding: 30px; max-width: 500px; margin: 0 auto;">
                                    <h2 style="color: #28a745;">✅ Logout Successful!</h2>
                                    <p style="margin: 20px 0; color: #6c757d;">
                                        You have successfully logged out from the WhatsApp API application.
                                    </p>
                                    <div style="margin: 30px 0;">
                                        <strong>For maximum security:</strong>
                                        <ul style="text-align: left; margin: 15px 0; color: #6c757d;">
                                            <li>Close this browser tab, or</li>
                                            <li>Click the button below to force re-login</li>
                                        </ul>
                                    </div>
                                    <button onclick="forceRelogin()" style="
                                        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                                        color: white;
                                        border: none;
                                        padding: 12px 24px;
                                        border-radius: 6px;
                                        font-size: 16px;
                                        cursor: pointer;
                                        margin: 10px;
                                    ">🔄 Refresh & Force Re-login</button>
                                    <button onclick="window.close()" style="
                                        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                        color: white;
                                        border: none;
                                        padding: 12px 24px;
                                        border-radius: 6px;
                                        font-size: 16px;
                                        cursor: pointer;
                                        margin: 10px;
                                    ">❌ Close Tab</button>
                                </div>
                            </div>
                        `;
                        
                        // Add global function for force relogin
                        window.forceRelogin = () => {
                            // Try to clear browser auth by making request with invalid auth
                            fetch(window.location.origin + '{{ .AppBasePath }}/app/devices', {
                                method: 'GET',
                                headers: {
                                    'Authorization': 'Basic ' + btoa('invalid:invalid')
                                }
                            }).finally(() => {
                                // Force reload after attempt
                                setTimeout(() => {
                                    window.location.reload(true);
                                }, 500);
                            });
                        };
                    }, 1500);
                }
            }
        },
        mounted() {
            // Initialize app container as hidden
            document.getElementById('app').style.display = 'none';
            
            if (window["WebSocket"]) {
                this.app_ws = new WebSocket(constructWebSocketURL());

                this.app_ws.onopen = (evt) => {
                    this.app_ws.send(JSON.stringify({
                        "code": "FETCH_DEVICES",
                        "message": "List device"
                    }));
                    
                    // Show app container and hide splash screen with a slight delay
                    setTimeout(() => {
                        document.getElementById('app').style.display = 'block';
                        document.getElementById('splash-screen').classList.add('fade-out');
                    }, 1000);
                };

                this.app_ws.onerror = (error) => {
                     console.error('WebSocket error:', error);
                     showErrorInfo('Connection error occurred. Please refresh the page.');
                     // Hide splash screen and show error state
                     setTimeout(() => {
                         document.getElementById('app').style.display = 'block';
                         document.getElementById('splash-screen').classList.add('fade-out');
                     }, 1000);
                };

                this.app_ws.onmessage = (evt) => {
                    const message = JSON.parse(evt.data)
                    switch (message.code) {
                        case 'LOGIN_SUCCESS':
                            showSuccessInfo(message.message)
                            $('#modalLogin').modal('hide');

                            // fetch devices
                            this.handleReloadDevice()
                            break;
                        case 'LIST_DEVICES':
                            this.connected_devices = message.result
                            break;
                        case 'FETCH_DEVICES_ERROR':
                            // Handle device fetching error from WebSocket
                            showErrorInfo('Failed to fetch devices: ' + message.message)
                            console.error('[WebSocket] Device fetch error:', message.message)
                            break;
                        case 'LOGOUT_COMPLETE':
                            // Handle successful cleanup after remote logout
                            showSuccessInfo('✅ ' + message.message)
                            console.log('[LOGOUT_COMPLETE] Remote logout cleanup completed:', message)
                            // Optionally refresh the device list
                            this.handleReloadDevice()
                            break;
                        default:
                            console.log(message)
                    }
                };
            } else {
                console.error('Your browser does not support WebSockets');
                // Hide splash screen if WebSocket is not supported
                document.getElementById('splash-screen').classList.add('fade-out');
            }
        },
    }).mount('#app')
</script>
</body>
</html>
